Object.defineProperty(exports,"__esModule",{value:true});exports.realm=undefined;var _createClass=function(){function defineProperties(target,props){for(var i=0;i<props.length;i++){var descriptor=props[i];descriptor.enumerable=descriptor.enumerable||false;descriptor.configurable=true;if("value"in descriptor)descriptor.writable=true;Object.defineProperty(target,descriptor.key,descriptor);}}return function(Constructor,protoProps,staticProps){if(protoProps)defineProperties(Constructor.prototype,protoProps);if(staticProps)defineProperties(Constructor,staticProps);return Constructor;};}();var _realm=require('realm');var _realm2=_interopRequireDefault(_realm);var _FileService=require('./FileService');var _FileService2=_interopRequireDefault(_FileService);var _model=require('./model');function _interopRequireDefault(obj){return obj&&obj.__esModule?obj:{default:obj};}function _classCallCheck(instance,Constructor){if(!(instance instanceof Constructor)){throw new TypeError("Cannot call a class as a function");}}var realm=exports.realm=new _realm2.default({schema:[_model.ProductSchema,_model.ParticipantSchema,_model.ScoreSchema,_model.EmailSchema]});var AppService=function(){function AppService(){_classCallCheck(this,AppService);}_createClass(AppService,[{key:'getEmail',value:function getEmail(){return realm.objectForPrimaryKey('Email',0);}},{key:'addEmail',value:function addEmail(email){var e=this.getEmail();if(typeof e!='undefined'){this.removeEmail();}realm.write(function(){realm.create('Email',{id:0,email:email});});}},{key:'removeEmail',value:function removeEmail(){var _this=this;var e=this.getEmail();if(typeof e!='undefined'){realm.write(function(){realm.delete(_this.getEmail());});}}},{key:'getProduct',value:function getProduct(name){return realm.objectForPrimaryKey('Product',name);}},{key:'getProducts',value:function getProducts(){return realm.objects('Product');}},{key:'addProduct',value:function addProduct(name,desc,system){var product=this.getProduct(name);if(typeof product!='undefined')return-1;if(name==='')return-2;realm.write(function(){realm.create('Product',{name:name,description:desc,system:system,date:new Date(),participants:[]});});return 0;}},{key:'removeProduct',value:function removeProduct(name){var product=this.getProduct(name);if(typeof product!='undefined'){for(var _iterator=product.participants,_isArray=Array.isArray(_iterator),_i=0,_iterator=_isArray?_iterator:_iterator[typeof Symbol==='function'?Symbol.iterator:'@@iterator']();;){var _ref;if(_isArray){if(_i>=_iterator.length)break;_ref=_iterator[_i++];}else{_i=_iterator.next();if(_i.done)break;_ref=_i.value;}var participant=_ref;realm.write(function(){realm.delete(participant.survey);});}realm.write(function(){realm.delete(product.participants);realm.delete(product);});}_FileService2.default.deleteFile(name);}},{key:'checkParticipant',value:function checkParticipant(productName,id){var p=realm.objectForPrimaryKey('Participant',this.append(productName,id));if(typeof p!='undefined')return-1;if(id==='')return-2;return 0;}},{key:'addParticipant',value:function addParticipant(productName,id,notes){id=this.append(productName,id);var p=realm.objectForPrimaryKey('Participant',id);if(typeof p!='undefined')return-1;if(id==='')return-2;var product=this.getProduct(product);realm.write(function(){var participant=realm.create('Participant',{id:id,date:new Date(),notes:notes,survey:[]});product.participants.push(participant);});return 0;}},{key:'calcScore',value:function calcScore(values){var s=0;for(var j=0;j<values.length;j++){if((j+1)%2==0){s+=5-values[j];}else{s+=values[j]-1;}}return s*2.5;}},{key:'getScore',value:function getScore(id){var p=realm.objectForPrimaryKey('Participant',id);return this.calcScore(p.survey.map(function(x){return x.value;}));}},{key:'addScore',value:function addScore(product,id,qid,value){var _this2=this;id=this.append(product,id);var p=realm.objectForPrimaryKey('Participant',id);if(typeof p==='undefined')return-1;realm.write(function(){var score=realm.create('Score',{id:_this2.append(id,qid),value:value},true);p.survey.push(score);});}},{key:'getStat',value:function getStat(product){var _this3=this;var p=this.getProduct(product);if(typeof p!='undefined'){var stat={size:p.participants.length,mean:0,min:0,max:0,std:0};if(stat.size==0)return stat;var scores=p.participants.map(function(x){return _this3.getScore(x.id);});stat.mean=scores.reduce(function(x,y){return(x+y)/stat.size;});if(stat.size==1)stat.std=0;else{stat.std=Math.sqrt(scores.map(function(x){return Math.pow(x-stat.mean,2);}).reduce(function(x,y){return x+y;})/(stat.size-1));}stat.min=scores.reduce(function(x,y){return Math.min(x,y);});stat.max=scores.reduce(function(x,y){return Math.max(x,y);});return this.truncate(stat);}}},{key:'exportProduct',value:function exportProduct(product,emailAddr){var p=this.getProduct(product);if(typeof p!='undefined'){var data='Product Name\t \
					Participant ID\t \
					Notes\t \
					SUS 1\t \
					SUS 2\t \
					SUS 3\t \
					SUS 4\t \
					SUS 5\t \
					SUS 6\t \
					SUS 7\t \
					SUS 8\t \
					SUS 9\t \
					SUS 10\t \
					SUS Score\n';for(var _iterator2=p.participants,_isArray2=Array.isArray(_iterator2),_i2=0,_iterator2=_isArray2?_iterator2:_iterator2[typeof Symbol==='function'?Symbol.iterator:'@@iterator']();;){var _ref2;if(_isArray2){if(_i2>=_iterator2.length)break;_ref2=_iterator2[_i2++];}else{_i2=_iterator2.next();if(_i2.done)break;_ref2=_i2.value;}var participant=_ref2;data+=this.tabulate([p.name,this.parse(participant.id),participant.notes]);data+=this.tabulate(participant.survey.map(function(x){return x.value;}));data+=this.getScore(participant.id)+'\n';}_FileService2.default.writeFile(product,data);return _FileService2.default.emailFile(product,emailAddr);}}},{key:'append',value:function append(head,tail){return head+'.'+tail;}},{key:'parse',value:function parse(id){return id.substring(id.indexOf('.')+1,id.length);}},{key:'tabulate',value:function tabulate(words){return words.join('\t')+'\t';}},{key:'truncate',value:function truncate(floats){for(f in floats){floats[f]=+floats[f].toFixed(3);}return floats;}}]);return AppService;}();var App=new AppService();Object.freeze(App);exports.default=App;